/*******************************
	ImportJS Version 1.0.0
	
    A basic package-structuring import system for JavaScript Objects.
	
    Copyright (c) 2013 Greg McLeod  (Email: cleod9{at}gmail.com)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
	
	It is requested that you maintain all or part of this copyright notice even in the minified version.
*******************************/

var ImportJS={pkgs:{},uncompiled:[],compiled:[],settings:{debug:false,delimiter:"."},pack:function(e,t,n){if(typeof e!="string")throw new Error("ImportJS Error: Provided package ID must be a string.");if(typeof t!="object"&&typeof t!="function")throw new Error("ImportJS Error: Provided class was not an Object or Function.");var r=e.split(ImportJS.settings.delimiter);if(r.length>0){var i=function(r,s){if(s.length==1){if(typeof r[s[0]]!="undefined")throw new Error("ImportJS Error: Package "+e+" already exists.");else{if(n===false){ImportJS.uncompiled.push(e);r[s[0]]=t}else{ImportJS.compiled.push(e);r[s[0]]=t()}}}else{if(typeof r[s[0]]=="undefined")r[s[0]]={};i(r[s[0]],s.slice(1))}};i(ImportJS.pkgs,r)}else throw new Error("ImportJS Error: Invalid package ID.")},unpack:function(e){if(typeof e!="string")throw new Error("ImportJS Error: Provided package ID must be a string.");var t=e.split(ImportJS.settings.delimiter);if(t.length>0){var n=function(t,r){if(typeof t[r[0]]=="undefined")throw new Error("ImportJS Error: Package ID "+e+" does not exist.");if(r.length==1){if(ImportJS.uncompiled.indexOf(e)>=0){var i=t[r[0]]();ImportJS.uncompiled.splice(ImportJS.uncompiled.indexOf(e),1);ImportJS.compiled.push(e);t[r[0]]=i[0];i[1]()}return t[r[0]]}else return n(t[r[0]],r.slice(1))};return n(ImportJS.pkgs,t)}else throw new Error("Package.js Error: Invalid package ID.")},compile:function(){while(ImportJS.uncompiled.length>0){ImportJS.unpack(ImportJS.uncompiled[0])}},preload:function(e){if(typeof e!="object")throw new Error("ImportJS Error: No parameters supplied.");var t={baseUrl:e.baseUrl||"",files:e.files||[],ready:e.ready||null,error:e.error||null,removeTags:e.removeTags===false?false:true,strict:e.strict===false?false:true,timeout:e.timeout?e.timeout:5e3,libs:e.libs||[],autocompile:e.autocompile===false?false:true};if(t.baseUrl=="./"||t.baseUrl=="")t.baseUrl=".";if(t.baseUrl.lastIndexOf("/")==t.baseUrl.length-1)t.baseUrl=t.baseUrl.substr(0,t.baseUrl.length-1);var n;var r=typeof t.files.length=="number"?t.files:[];var i=t.libs;var s=[];var o=[];var u=[];var a=function(e,t,n){for(var i in e){if(typeof e[i]=="string"){r.push(t+"/"+e[i]);s.push((n+ImportJS.settings.delimiter+i).substr(ImportJS.settings.delimiter.length))}else if(typeof e[i]=="object")a(e[i],t+"/"+i,n+ImportJS.settings.delimiter+i);else throw new Error("ImportJS Error: Paths can only contain Objects and String values.")}};if(r.length==0){a(t.files,t.baseUrl,"")}else{for(n=0;n<t.files.length;n++){var f=t.files[n].split("/").join(ImportJS.settings.delimiter);f=f.substr(0,f.length-3);s.push(f)}}if(r.length==0){if(typeof t.ready=="function")t.ready()}var l=function(e,n){var s=false;var a=document.getElementsByTagName("head")[0];var f=document.createElement("script");var l=null;f.type="text/javascript";var c=function(){if(t.removeTags)a.removeChild(f);s=true;clearTimeout(l);if(n&&t.strict){if(ImportJS.compiled.indexOf(n)<0&&ImportJS.uncompiled.indexOf(n)<0)throw new Error("Import js Error: Invalid or missing package definition for "+n+" (using strict)")}o.push(e);if(o.length==r.length+i.length){if(t.autocompile){ImportJS.compile()}if(typeof t.ready=="function")t.ready(o)}};var h=function(){if(t.removeTags)a.removeChild(f);u.push(e);clearTimeout(l);if(o.length+u.length>=r.length+i.length){if(typeof t.error=="function")t.error(u);if(ImportJS.settings.debug)console.log("ImportJS Error: Could not preload the following files: ["+u.join(", ")+"]")}};l=setTimeout(function(){if(ImportJS.settings.debug)console.log("ImportJS Error: Timed out on file: "+e);h()},t.timeout);f.onreadystatechange=function(){if(!s&&(!f.readyState||this.readyState=="complete"||this.readyState=="loaded")){c()}};f.onload=c;f.onerror=h;f.src=e;a.appendChild(f)};var c=function(){for(var e=0;e<r.length;e++)l(r[e],s[e])};if(i.length>0){var h=0;var p=function(e,n,r){ImportJS.preload({baseUrl:t.baseUrl,removeTags:t.removeTags,strict:false,timeout:t.timeout,autocompile:false,files:[e],ready:n,error:r})};var d,v;d=function(e){o.push(e[0]);if(h<i.length)p(i[h++],d,v);else if(r.length<=0){if(typeof t.ready=="function")t.ready(o)}else{c()}};v=function(e){u.push(e[0]);if(ImportJS.settings.debug)console.log("ImportJS Error: Could not preload the following files: ["+e.join(", ")+"]");if(typeof t.error=="function")t.error(u)};p(i[h++],d,v)}else{c()}}}